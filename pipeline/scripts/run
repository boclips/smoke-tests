#!/usr/bin/env bash

strip_xml_for_junit2alertmanager () {
    xmllint --xpath '/testsuites/testsuite[@name!=""]' -
}

produce_output () {
    apt install libxml2-utils
    strip_xml_for_junit2alertmanager \
        < source/cypress/results/test-output.xml \
        > test-results/test-output.xml
    mkdir -p source/cypress/{screenshots,videos}
    touch source/cypress/{screenshots,videos}/tar-avoid-empty-dir
    cd "source/cypress" || exit
    tar -cf ../../test-results/results.tar \
        screenshots/* \
        videos/*
}
trap produce_output EXIT

if [ -z "$SPEC" ]
then
    echo "Must specify SPEC"
    exit 1
fi

(
cd source || exit 1
npm ci || exit 1
npm run test -- --spec=$SPEC
)
